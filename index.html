<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Odd Heroes</title>
  <link rel="icon" type="image/png" href="oddheroes/images/OHO.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    html, body {
      margin: 0;
      padding: 0;
      overflow: auto;
      background-color: #000;
      font-family: 'Share Tech Mono', monospace;
      color: #0f0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      user-select: none;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 10px #0f0;
      text-align: center;
    }
    .category-container {
      width: 90%;
      max-width: 500px;
      margin-bottom: 1rem;
    }
    .category-title {
      font-size: 1.8rem;
      margin: 0.5rem 0;
      text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
      text-align: left;
      cursor: pointer;
      padding: 0.7rem 1rem;
      background: linear-gradient(to bottom, #003300, #001100);
      border: 2px solid #0f0;
      border-radius: 10px;
      box-shadow: 0 0 15px #0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: box-shadow 0.3s ease, background 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .category-title:hover {
      box-shadow: 0 0 20px #0f0, 0 0 30px #0f0;
      background: linear-gradient(to bottom, #005500, #003300);
    }
    .category-title::after {
      content: '▶';
      font-size: 1.5rem;
      text-shadow: 0 0 5px #0f0;
      transition: transform 0.3s ease;
    }
    .category-title.expanded::after {
      content: '▼';
    }
    .selected-hero {
      font-size: 1.2rem;
      margin-right: 1rem;
      text-shadow: 0 0 5px #0f0;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      padding: 10px;
      background-color: #001100;
      border-radius: 8px;
      border: 1px solid #0f0;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      visibility: hidden;
      max-width: 460px;
      width: 100%;
      box-sizing: border-box;
    }
    .grid-container.expanded {
      max-height: 500px;
      opacity: 1;
      visibility: visible;
    }
    .hero-tile {
      background-color: #003300;
      border: 2px solid #0f0;
      border-radius: 8px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 0.5rem;
      min-height: 80px;
      position: relative;
    }
    .hero-tile:hover {
      background-color: #005500;
      box-shadow: 0 0 15px #0f0, 0 0 30px #0f0;
    }
    .hero-tile.selected {
      background-color: #00ff00;
      color: #000;
      box-shadow: 0 0 25px #00ff00, 0 0 40px #00ff00;
      font-weight: bold;
    }
    .hero-icon {
      font-size: 1.8rem;
      margin-bottom: 0.3rem;
      position: relative;
    }
    .hero-icon-img {
      width: 1.8rem;
      height: 1.8rem;
      object-fit: contain;
      vertical-align: middle;
    }
    #start-button {
      margin: 1.5rem 0;
      padding: 0.8rem 2rem;
      font-size: 1.3rem;
      background-color: #0f0;
      border: none;
      border-radius: 8px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #0f0;
      display: none;
      transition: background-color 0.3s ease;
    }
    #start-button:hover {
      background-color: #00ff00;
      box-shadow: 0 0 20px #00ff00;
    }
    #start-button:disabled {
      background-color: #555;
      cursor: not-allowed;
      box-shadow: none;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #001100;
      border: 2px solid #0f0;
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 0 20px #0f0;
      width: 300px;
    }
    .modal-content h2 {
      font-size: 1.5rem;
      text-shadow: 0 0 10px #0f0;
    }
    .options {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
      flex-wrap: wrap;
      gap: 10px;
    }
    .option {
      background-color: #003300;
      border: 2px solid #0f0;
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      width: 30%;
      transition: background-color 0.3s ease;
      box-sizing: border-box;
    }
    .option:hover {
      background-color: #005500;
    }
    .option .icon {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.3rem;
    }
    .single-option {
      width: 60%;
      margin: 0 auto;
    }
    #stat-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 1001; /* Above other modals */
    }
    #stat-modal-content {
      background-color: #001100;
      border: 2px solid #0f0;
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 0 20px #0f0;
      width: 300px;
    }
    #stat-modal-content h2 {
      font-size: 1.5rem;
      text-shadow: 0 0 10px #0f0;
      margin-bottom: 1rem;
    }
    .stat-row {
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .stat-label {
      font-size: 1.2rem;
      width: 80px;
    }
    .stat-slider {
      flex-grow: 1;
      margin: 0 10px;
      -webkit-appearance: none;
      width: 100%;
      height: 10px;
      background: #003300;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }
    .stat-slider:hover {
      opacity: 1;
    }
    .stat-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 15px;
      height: 15px;
      background: #0f0;
      cursor: pointer;
    }
    .stat-slider::-moz-range-thumb {
      width: 15px;
      height: 15px;
      background: #0f0;
      cursor: pointer;
    }
    #total-points {
      font-size: 1.2rem;
      margin-top: 1rem;
      color: #0f0;
    }
    #confirm-stats {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1.1rem;
      background-color: #0f0;
      border: none;
      border-radius: 5px;
      color: #000;
      cursor: pointer;
    }
    #confirm-stats:hover {
      background-color: #00ff00;
    }
    @media (max-width: 400px) {
      h1 { font-size: 2rem; }
      .category-title { font-size: 1.5rem; padding: 0.5rem 0.8rem; }
      .category-title::after { font-size: 1.2rem; }
      .selected-hero { font-size: 1rem; }
      .hero-tile { font-size: 0.9rem; min-height: 70px; }
      .hero-icon { font-size: 1.5rem; }
      .hero-icon-img { width: 1.5rem; height: 1.5rem; }
      .grid-container { grid-template-columns: repeat(2, 1fr); max-width: 100%; }
      .option { width: 45%; }
      .single-option { width: 70%; }
      .option .icon { font-size: 1.5rem; }
      #stat-modal-content { width: 250px; }
      .stat-label { font-size: 1rem; }
      .stat-slider { height: 8px; }
      #total-points { font-size: 1rem; }
      #confirm-stats { font-size: 1rem; padding: 0.4rem 0.8rem; }
    }
  </style>
</head>
<body>
  <h1>Pick Your Odd Heroes</h1>
  <div id="categories"></div>
  <button id="start-button">Start Game</button>
  <div id="modals"></div>
  <div id="stat-modal" class="modal">
    <div id="stat-modal-content">
      <h2>Adjust Stats</h2>
      <div class="stat-row"><span class="stat-label">HP:</span><input type="range" min="0" max="100" value="0" class="stat-slider" id="hp-slider"><span id="hp-value">0</span></div>
      <div class="stat-row"><span class="stat-label">Stamina:</span><input type="range" min="0" max="100" value="0" class="stat-slider" id="stamina-slider"><span id="stamina-value">0</span></div>
      <div class="stat-row"><span class="stat-label">Attack:</span><input type="range" min="0" max="100" value="0" class="stat-slider" id="attack-slider"><span id="attack-value">0</span></div>
      <div class="stat-row"><span class="stat-label">Defense:</span><input type="range" min="0" max="100" value="0" class="stat-slider" id="defense-slider"><span id="defense-value">0</span></div>
      <div class="stat-row"><span class="stat-label">Speed:</span><input type="range" min="0" max="100" value="0" class="stat-slider" id="speed-slider"><span id="speed-value">0</span></div>
      <div id="total-points">Total Points: 0/100</div>
      <button id="confirm-stats">Confirm Stats</button>
    </div>
  </div>
  <script src="heroes-list.js"></script>
  <script src="abilities.js"></script>
  <script>
    // Error handling for heroData and abilityEffects
    if (typeof heroData === 'undefined' || typeof abilityEffects === 'undefined') {
      console.error('Error: heroData or abilityEffects is not defined. Ensure heroes-list.js and abilities.js are loaded correctly.');
      const errorMessage = document.createElement('div');
      errorMessage.style.color = '#f00';
      errorMessage.textContent = 'Error loading hero data or abilities. Please check if heroes-list.js and abilities.js are correctly included.';
      document.body.appendChild(errorMessage);
    } else {
      // Dynamically generate categories and hero tiles
      const categoriesContainer = document.getElementById('categories');
      const modalsContainer = document.getElementById('modals');
      const statModal = document.getElementById('stat-modal');
      const categories = heroData.map(cat => ({
        title: null,
        list: null,
        selected: null,
        display: null,
        id: cat.id
      }));

      heroData.forEach((cat, index) => {
        // Create category container
        const categoryContainer = document.createElement('div');
        categoryContainer.className = 'category-container';
        // Create category title
        const categoryTitle = document.createElement('div');
        categoryTitle.className = 'category-title';
        categoryTitle.id = `${cat.id}-title`;
        categoryTitle.innerHTML = `<span class="selected-hero"></span>${cat.category}`;
        // Create grid container
        const gridContainer = document.createElement('div');
        gridContainer.className = 'grid-container';
        gridContainer.id = `${cat.id}-list`;
        // Populate hero tiles
        cat.heroes.forEach(hero => {
          const heroTile = document.createElement('div');
          heroTile.className = 'hero-tile';
          heroTile.innerHTML = `<div class="hero-icon">${hero.icon}</div>${hero.name}`;
          gridContainer.appendChild(heroTile);
        });
        categoryContainer.appendChild(categoryTitle);
        categoryContainer.appendChild(gridContainer);
        categoriesContainer.appendChild(categoryContainer);
        // Update categories array
        categories[index].title = categoryTitle;
        categories[index].list = gridContainer;
        categories[index].display = categoryTitle.querySelector('.selected-hero');
        // Create modal for each hero
        cat.heroes.forEach(hero => {
          const modal = document.createElement('div');
          modal.id = `${hero.name.toLowerCase().replace(/\s+/g, '-')}-modal`;
          modal.className = 'modal';
          const modalContent = document.createElement('div');
          modalContent.className = 'modal-content';
          modalContent.innerHTML = `<h2>Choose ${hero.name}'s Ability</h2><div class="options"></div>`;
          const optionsContainer = modalContent.querySelector('.options');
          hero.abilities.forEach((ability, idx) => {
            const option = document.createElement('div');
            option.className = `option ${hero.abilities.length === 1 ? 'single-option' : 'generic-option'}`;
            option.setAttribute('data-choice', ability.choice);
            option.innerHTML = `<span class="icon">${hero.icon}</span>${ability.label}${ability.description ? '<br>' + ability.description : ''}`;
            optionsContainer.appendChild(option);
          });
          modal.appendChild(modalContent);
          modalsContainer.appendChild(modal);
        });
      });

      const startButton = document.getElementById('start-button');
      let selectedHeroes = [];
      const sessionId = crypto.randomUUID();
      // Disable start button by default
      startButton.disabled = true;

      // Stat modal elements
      const hpSlider = document.getElementById('hp-slider');
      const staminaSlider = document.getElementById('stamina-slider');
      const attackSlider = document.getElementById('attack-slider');
      const defenseSlider = document.getElementById('defense-slider');
      const speedSlider = document.getElementById('speed-slider');
      const hpValue = document.getElementById('hp-value');
      const staminaValue = document.getElementById('stamina-value');
      const attackValue = document.getElementById('attack-value');
      const defenseValue = document.getElementById('defense-value');
      const speedValue = document.getElementById('speed-value');
      const totalPoints = document.getElementById('total-points');
      const confirmStats = document.getElementById('confirm-stats');

      // Update total points and values
      function updateStats() {
        const hp = parseInt(hpSlider.value);
        const stamina = parseInt(staminaSlider.value);
        const attack = parseInt(attackSlider.value);
        const defense = parseInt(defenseSlider.value);
        const speed = parseInt(speedSlider.value);
        const total = hp + stamina + attack + defense + speed;
        hpValue.textContent = hp;
        staminaValue.textContent = stamina;
        attackValue.textContent = attack;
        defenseValue.textContent = defense;
        speedValue.textContent = speed;
        totalPoints.textContent = `Total Points: ${total}/100`;
        confirmStats.disabled = total !== 100;
      }

      // Sync sliders
      [hpSlider, staminaSlider, attackSlider, defenseSlider, speedSlider].forEach(slider => {
        slider.addEventListener('input', updateStats);
      });

      // Toggle categories
      categories.forEach(cat => {
        cat.title.addEventListener('click', () => {
          const expanded = cat.list.classList.contains('expanded');
          categories.forEach(c => {
            c.list.classList.remove('expanded');
            c.title.classList.remove('expanded');
          });
          if (!expanded) {
            cat.list.classList.add('expanded');
            cat.title.classList.add('expanded');
          }
        });
      });

      // Hero and ability selection
      categories.forEach(cat => {
        cat.list.addEventListener('click', e => {
          const tile = e.target.closest('.hero-tile');
          if (!tile) return;
          const heroName = tile.querySelector('.hero-icon').nextSibling.textContent.trim();
          const heroIcon = tile.querySelector('.hero-icon').textContent;
          if (cat.selected) {
            const selectedTile = cat.list.querySelector('.selected');
            if (selectedTile) selectedTile.classList.remove('selected');
          }
          tile.classList.add('selected');
          cat.selected = { name: heroName, icon: heroIcon, ability: null };
          cat.display.textContent = `${heroIcon} ${heroName}`;
          selectedHeroes = categories.map(c => c.selected).filter(h => h);
          const heroCat = heroData.find(c => c.id === cat.id);
          const hero = heroCat.heroes.find(h => h.name === heroName);
          const modal = document.getElementById(`${heroName.toLowerCase().replace(/\s+/g, '-')}-modal`);
          modal.style.display = 'flex';
          const options = modal.querySelectorAll('.option');
          options.forEach(opt => {
            opt.addEventListener('click', function handleChoice() {
              const choice = this.getAttribute('data-choice');
              cat.selected.ability = choice;
              const ability = hero.abilities.find(a => a.choice === choice);
              cat.display.textContent = `${heroIcon} ${heroName} (${ability.label})`;
              if (abilityEffects[choice]) {
                const result = abilityEffects[choice].execute({ name: heroName });
                console.log(`Preview: ${result.message}`);
              } else {
                console.warn(`No effect defined for ability: ${choice}`);
              }
              modal.style.display = 'none';
              cat.list.classList.remove('expanded');
              cat.title.classList.remove('expanded');
              options.forEach(o => o.removeEventListener('click', handleChoice));

              // Show stat adjustment modal
              statModal.style.display = 'flex';
              // Reset sliders to 0
              hpSlider.value = 0;
              staminaSlider.value = 0;
              attackSlider.value = 0;
              defenseSlider.value = 0;
              speedSlider.value = 0;
              updateStats();
            }, { once: true });
          });
          startButton.style.display = selectedHeroes.length === categories.length ? 'inline-block' : 'none';
          startButton.disabled = selectedHeroes.length !== categories.length;
        });
      });

      // Confirm stats and proceed
      confirmStats.addEventListener('click', () => {
        const hp = parseInt(hpSlider.value);
        const stamina = parseInt(staminaSlider.value);
        const attack = parseInt(attackSlider.value);
        const defense = parseInt(defenseSlider.value);
        const speed = parseInt(speedSlider.value);
        if (hp + stamina + attack + defense + speed === 100) {
          statModal.style.display = 'none';
          startButton.style.display = selectedHeroes.length === categories.length ? 'inline-block' : 'none';
          startButton.disabled = selectedHeroes.length !== categories.length;
          // Optionally store stats with the selected hero (e.g., in cat.selected.stats)
          const currentCat = categories.find(c => c.selected && c.selected.ability);
          if (currentCat) {
            currentCat.selected.stats = { hp, stamina, attack, defense, speed };
            console.log(`${currentCat.selected.name} stats:`, { hp, stamina, attack, defense, speed });
          }
        }
      });

      // Start button - redirect with selected heroes and sessionId
      startButton.addEventListener('click', () => {
        if (selectedHeroes.length !== categories.length) return;
        const heroesQuery = encodeURIComponent(JSON.stringify(selectedHeroes.map(h => ({
          name: h.name,
          ability: h.ability,
          stats: h.stats || { hp: 0, stamina: 0, attack: 0, defense: 0, speed: 0 }
        }))));
        window.location.href = `matchmaking.html?heroes=${heroesQuery}&sessionId=${encodeURIComponent(sessionId)}`;
      });
    }
  </script>
</body>
</html>
