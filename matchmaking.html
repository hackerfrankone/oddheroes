<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Odd Heroes - Matchmaking</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

html, body {
  margin: 0;
  padding: 0;
  background-color: #000;
  color: #0f0;
  font-family: 'Share Tech Mono', monospace;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100vh;
  user-select: none;
}

h1 {
  font-size: 2rem;
  margin-bottom: 1rem;
  text-shadow: 0 0 10px #0f0;
  text-align: center;
}

#status {
  font-size: 1.5rem;
  margin: 1rem 0;
  text-shadow: 0 0 10px #0f0;
}

#opponent-hero {
  font-size: 1.2rem;
  margin-top: 1rem;
  text-shadow: 0 0 10px #0f0;
}
</style>
</head>
<body>
<h1>Odd Heroes - Matchmaking</h1>
<div id="status">Searching for opponent...</div>
<div id="opponent-hero"></div>

<script>
// Get selected hero from URL
const params = new URLSearchParams(window.location.search);
const hero = params.get('hero') || 'Unknown Hero';

const statusDiv = document.getElementById('status');
const opponentDiv = document.getElementById('opponent-hero');

const WORKER_URL = 'https://matchmaking.oddheroesonline.workers.dev/find-match';
let playerId = null;

// Poll the Worker every 2 seconds
async function joinQueue() {
  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ hero, playerId })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    console.log('Queue response:', data);

    playerId = data.playerId || playerId;

    if (data.status === 'waiting') {
      statusDiv.textContent = 'Searching for opponent...';
      setTimeout(joinQueue, 2000); // poll again
    } else if (data.status === 'matched') {
      statusDiv.textContent = 'Opponent found!';
      opponentDiv.textContent = `Your game ID: ${data.gameId}`;
      // Redirect to game page
      window.location.href = `game.html?gameId=${data.gameId}&hero=${encodeURIComponent(hero)}`;
    } else {
      statusDiv.textContent = 'Unknown status...';
      setTimeout(joinQueue, 2000);
    }

  } catch (err) {
    console.error('Matchmaking error:', err);
    statusDiv.textContent = 'Error connecting to server. Retrying...';
    setTimeout(joinQueue, 3000);
  }
}

// Start polling
joinQueue();
</script>
</body>
</html>
